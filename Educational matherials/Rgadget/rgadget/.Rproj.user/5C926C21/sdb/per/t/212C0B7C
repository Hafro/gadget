{
    "contents" : "---\ntitle: \"Rgadget\"\nauthor: \"Bjarki Þór Elvarsson\"\ndate: \"þri 16.sep 2014\"\noutput: beamer_presentation\n---\n\n## Interacting with Gadget from R\n- Rgadget (still in development) is a collection of functions that aid in the development of and interact with Gadget models\n- Its core functions are:\n    + gadget.iterative: an implementation of the iterative refweighting algorithm in R.   \n    + gadget.fit: collects output from Gadget and compares to data. \n    + gadget.ypr: calculates Yield-per-recruit curves for a modeled stock\n    + gadget.forward: projects the state of the modeled ecosystems based on fixed recruitment or with process error.\n    + gadget.boot* : bootstrap variants of functions above\n    + gadget.simulate : independent implementation of Gadget in R (not discussed here)\n\n## Obtaining Rgadget\n- Still under active development and therefor it does not exist in a packaged form.\n- Can be obtained from: \n    + https://r-forge.r-project.org/projects/rgadget/\n- The package depends on a number of other packages:\n```{r,eval=FALSE}\ninstall.packages(c('plyr','dplyr','data.table',\n                   'parallel','lubridate',\n                   'stringr','ggplot2',\n                   'gridExtra','reshape2'))\n```\n\n```{r,echo=FALSE,warning=FALSE,message=FALSE}\nsource('~/Documents/rgadget/trunk/gadgetFileIO.R')\nsource('~/Documents/rgadget/trunk/gadgetfunctions.R')\nsource('~/Documents/rgadget/trunk/gadgetClass.R')\nsource('~/Documents/rgadget/trunk/gadgetMethods.R')\nsource('~/Documents/rgadget/trunk/function.R')\n\nlibrary(plyr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(grid)\nlibrary(pander)\nsetwd('~/Dropbox/gadget-models/08-tusk/')\n```\n## gadget.iterative\nThe gadget.iterative functions implements iterative reweighting heuristic for the likelihood components.\n\nThe general idea behind the iterative re-weighing is to assign the inverse variance of the fitted residuals as component weights. The variances, and hence the final weights, are calculated according the following algorithm:\n\n- Calculate the initial SS given the initial\n  parametrization. Assign the inverse SS as the initial weight for all\n  likelihood components. \n- For each likelihood component, do an optimization run with\n  the initial score for that component set to 10000. Then estimate the\n  residual variance using the resulting SS of that component divided\n  by the degrees of freedom ($df^*$), i.e. $\\hat{\\sigma}^2 = \\frac{SS}{df^*}$.\n-  After the optimization set the final weight for that all\n  components as the inverse of the estimated variance from the step above\n  (weight $=1/\\hat{\\sigma}^2$). \n\n## gadget.iterative (cont.)\nThe effective number of data-points ($df^{*}$) is used as a proxy\nfor the degrees of freedom determined from the number of non-zero\ndata-points.\n\n- Viewed as satisfactory proxy when the data-set is\nlarge\n- For smaller data-sets this could be a gross overestimate.\n\nIn particular, if the survey indices are weighed on their own while the\nyearly recruitment is estimated they could be over-fitted.  In general \nproblem such as these can\nbe solved with component grouping, that is in step 2 the likelihood\ncomponents that should behave similarly, such as survey indices, should\nbe heavily weighted and optimized together.\n\n\n\n## Tusk example \n```{r,eval=FALSE}\ntmp <- \n  gadget.iterative(rew.sI = TRUE,\n     grouping = list(sind = c('si2039','si4069',\n                              'si70110'),                          \n                     survey = c('ldist.survey',\n                                'alkeys.survey'),                                          \n                     catch = c('ldist.catch',\n                               'alkeys.catch')),                                          \n     params.file = 'params.base',\n     optinfofile = 'optinfofile',\n     wgts = 'WGTS')\n```\n\n\n## gadget.fit\nGadget-models can produce output by a number of dimensions.\n\n- Specialised \"printers\" are implemented (see chapter 9 of the userguide)\n- Output can be aggregated using agg files\n- Digesting the output can be an excercise in bookkeeping. \n- Enter 'gadget.fit':\n    + collects all observation data referred to in the likelihood file\n    + requests predictions/model fit from Gadget based on the dimensions in of the observations\n    + merges the observations and model fit \n\n## Tusk example (cont.)\n\n```{r,warning=FALSE}\nsetwd('~/Dropbox/gadget-models/08-tusk')\nfit <- gadget.fit(mat.par = c(-8.6512,0.1403))\n```\n\n## Tusk -- fit statistics\n```{r,results='asis',echo=FALSE}\nresTable <- fit$resTable[tail(head(names(fit$resTable),-2),-1)]\nnames(resTable) <- c('ALKc','ALKs','LDc','LDs','SI 20-39',\n                     'SI 40-69','SI 70-110')\nrownames(resTable) <- c('Catch','Survey','Sind','Final')\npandoc.table(resTable,\n             split.tables=Inf)\n```\n\n## Tusk -- likelihood summary\n\n```{r,echo=FALSE}\nsummary.plot <-\n  ggplot(subset(fit$likelihoodsummary,\n                year!='all'),\n         aes(as.numeric(year), likelihood.value)) +\n  geom_point() + facet_wrap(~component) +theme_bw()+\n  xlab('Year') + ylab('Score')\nsummary.plot\n```\n\n## Tusk -- indices\n\n```{r,echo=FALSE}\ntmp <- rbind.fill(fit$sidat,\n                  ddply(fit$sidat,~year, summarise,\n                        number.x = sum(number.x*0.00000659*lower^3.01721 ),\n                        predict = sum(predict*0.00000659*lower^3.01721 ),\n                        upper = sum(upper*0.00000659*lower^3.01721 ),\n                        lower = sum(lower*0.00000659*lower^3.01721 ),\n                        lower = 110, lower = 180,\n                        length = 'Biomass'))\n\nsi.fit.survey <-\n  ggplot(tmp, aes(year,number.x)) +\n  geom_point() +\n  geom_line(aes(year,predict)) +\n  geom_linerange(data=subset(tmp,year==max(year)),\n                 aes(year,ymax=number.x,ymin=predict),col='green')+\n  geom_text(data=mutate(subset(tmp,year==min(year)),y=Inf),\n            aes(year,y,label=length), vjust = 2,hjust = -1)+\n  facet_wrap(~length,scale='free_y',ncol=2) + theme_bw() +\n  ylab('Index') + xlab('Year') +\n  theme (panel.margin = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),\n         strip.background = element_blank(), strip.text.x = element_blank())\n\nsi.fit.survey\n```\n\n## Tusk -- Length distributions\n```{r,echo=FALSE,warning=FALSE}\nldist.fit.survey <-\n  ggplot(subset(fit$catchdist.fleets,\n                name == 'ldist.survey' ), #& year == '2012'\n         aes(lower,predicted)) +\n  geom_line(aes(lower,observed),col='gray') +\n  facet_wrap(~year+step) + theme_bw() + geom_line() +\n  geom_text(data=mutate(subset(fit$catchdist.fleets,\n              name == 'ldist.survey' & lower==min(lower)),y=Inf),\n            aes(lower,y,label=year), vjust = 2,hjust = -1)+\n  ylab('Proportion') + xlab('length') +\n  theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),\n         panel.margin = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),\n         strip.background = element_blank(), strip.text.x = element_blank())\nldist.fit.survey\n```\n\n## Tusk -- Biomass estimates\n```{r,echo=FALSE,warning=FALSE}\nssb.plot <- \n  ggplot(fit$res.by.year,aes(year,ssb/1000)) +\n  geom_bar(stat='identity') +\n  ylab(\"SSB (in tons)\") + xlab('Year') +  theme_bw() +\n  theme(legend.position = c(0.25,0.75), legend.title = element_blank(),\n        plot.margin = unit(c(0,0,0,0),'cm'))\nssb.plot\n```\n\n## Tusk -- parameter estimates\n\n```{r,echo=FALSE,warning=FALSE}\nselection.plot <-\n  ggplot(fit$suitability,\n         aes(l,suit,lty=fleet)) +\n  geom_line() +\n  theme_bw() + ylab('Suitability') + xlab('Length') +\n  theme(legend.position = c(0.8,0.25), legend.title = element_blank(),\n        plot.margin = unit(c(0,0,0,0),'cm')) \n\n\ngr.plot <-\n  ggplot(fit$stock.growth,\n         aes(age,length)) + \n  geom_line() +\n  theme_bw() + ylab('Length') + xlab('Age') +\n  theme(legend.position = c(0.25,0.75), legend.title = element_blank(),\n        plot.margin = unit(c(0,0,0,0),'cm'))\n\n\nrec.plot <-\n  ggplot(fit$res.by.year,aes(year,recruitment/1e6)) +\n  geom_bar(stat='identity') +\n  ylab(\"Recruitment (in millions)\") + xlab('Year') +  theme_bw() +\n  theme(legend.position = c(0.25,0.75), legend.title = element_blank(),\n        plot.margin = unit(c(0,0,0,0),'cm'))\n\nlibrary(gridExtra)\ngrid.arrange(selection.plot,gr.plot,rec.plot,ncol=2)\n```\n\n## gadget.ypr\nCalculates Yield-per-recruit within the model.\n\n- Tracks a single year class for a set time period\n- Fishing mortality is varied and the biomass caught is measured\n- As this is a length-based model the yield is more conservative\n\n\n```{r}\nsetwd('~/Dropbox/gadget-models/08-tusk')\nypr <- gadget.ypr(params.file='WGTS/params.final',\n                  ypr='WGTS/YPR')\n```\n\n## Tusk example (cont.)\n```{r,echo=FALSE}\nypr.plot <- \n  ggplot(ypr$ypr,aes(effort,bio)) +\n  geom_line() +\n  geom_segment(aes(x = effort,xend=effort,y=-Inf,yend=bio),\n               data=subset(ypr$ypr, effort == ypr$fmax)) +\n  geom_segment(aes(x = effort,xend=effort,y=-Inf,yend=bio),\n               data=subset(ypr$ypr, effort == ypr$f0.1$f0.1)) +\n  geom_text(data=subset(ypr$ypr,effort == ypr$fmax),\n            aes(label = sprintf('Fmax = %s',effort),\n                x = effort+0.04,y=0.2,angle=90)) +\n  geom_text(data=subset(ypr$ypr,effort == ypr$f0.1$f0.1),\n            aes(label = sprintf('F0.1 = %s',effort),\n                x = effort+0.04,y=0.2,angle=90)) +\n  theme_bw() +  xlab('Fishing mortality') + ylab('Yield per recruit') +\n  theme(legend.position='none',plot.margin = unit(c(0,0,0,0),'cm'))\nypr.plot\n```\n\n## gadget.forward\n\n- Projects the stock status forward based on assumptions for recruitment\n    + Recruitment can be fixed to an average of the last years prior \n    + or stochastic where the recruitment is an auto-regressive process\n- Provides projections of the stock by age and length, and total catches\n- Can project based on a range of F\n\n## Tusk - projections\n\n```{r}\nsetwd('~/Dropbox/gadget-models/08-tusk')\n\nprognFmax <-\n  gadget.forward(years=6,\n                 params.file='WGTS/params.final',\n                 pre='WGTS/PROGN', \n                 stochastic=FALSE,\n                 num.trials=1,\n                 effort=ypr$fmax)\n```\n\n## Tusk -- projected yield\n```{r,echo=FALSE,warning=FALSE,message=FALSE}\nmat.par = c(-8.6512,0.1403)\nprogn.ssb <-\n  prognFmax$lw %>%\n  filter(step == 1) %>%\n  group_by(year) %>%\n  summarise(ssb = sum(weight*logit(mat.par[1],\n              mat.par[2],length)*\n              number),\n            total.biomass = sum(number*weight))#,\n\nprogn.by.year <-\n  left_join(prognFmax$catch %>%\n            group_by(year) %>%\n            summarise(catch=sum(biomass.consumed)),\n            progn.ssb)\n\n\nprog.bio.plot <-\n  ggplot(progn.by.year,aes(year,ssb/1e6)) +\n  geom_rect(aes(xmin=max(fit$res.by.year$year),\n                xmax=Inf,ymin=-Inf,ymax=Inf),\n            fill = 'gray90', alpha=0.1) +\n  geom_line() +\n  theme_bw() + xlab('Year') + ylab('SSB (\\'000 tons)') +\n  theme(plot.margin = unit(c(0,0,0,0),'cm'),\n        legend.title = element_blank(),\n        legend.position = c(0.2,0.7))\n\n\nprog.catch.plot <-\n  ggplot(progn.by.year,aes(year,catch/1000)) +\n  geom_rect(aes(xmin=max(fit$res.by.year$year),\n                xmax=Inf,ymin=-Inf,ymax=Inf),\n            fill = 'gray90', alpha=0.1) +\n  geom_line() +\n  theme_bw() + xlab('Year') + ylab('Catch (\\'000 tons)') +\n  theme(plot.margin = unit(c(0,0,0,0),'cm'),\n        legend.title = element_blank(),\n        legend.position = c(0.2,0.7)) +\n  ylim(c(0,max(fit$res.by.year$catch/1000)))\n\nprog.rec.plot <- rec.plot + geom_bar(aes(year,10*recruitment),\n                                     data=prognFmax$recruitment,\n                                     fill='red',stat='identity')\n\ngrid.arrange(prog.bio.plot,prog.catch.plot,prog.rec.plot,ncol=2)\n```",
    "created" : 1410897328823.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1272005960",
    "id" : "212C0B7C",
    "lastKnownWriteTime" : 1410958266,
    "path" : "~/Dropbox/GadgetNamskeid/Rgadget/rgadget.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}